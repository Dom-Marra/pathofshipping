<form [formGroup]="itemForm">
    <mat-expansion-panel [expanded]="'true'">

        <mat-expansion-panel-header>
            <mat-panel-title>
                <div class="item-delete" (click)="$event.stopImmediatePropagation(); remove()">
                    <mat-icon class="icon-light">delete</mat-icon>
                </div>
            </mat-panel-title>
            <div *ngIf="!this.getEditName()" class="item-name" 
                (click)="$event.stopImmediatePropagation(); this.setEditName(true)" 
                role="button" aria-label="Edit item name">
                <p>{{itemForm.value.itemName}}</p>
                <mat-icon class="icon-light">edit</mat-icon>
            </div>
            <mat-form-field *ngIf="this.getEditName()" [floatLabel]="'never'" (click)="$event.stopImmediatePropagation();" >
                <input #itemNameInput matInput 
                    (keydown.Space)="$event.stopImmediatePropagation()" 
                    (keydown.enter)="$event.stopImmediatePropagation(); $event.target.blur()"
                    (blur)="this.setEditName(false)" type="text" autocomplete="off" placeholder="Item Name"  formControlName="itemName">
            </mat-form-field>
        </mat-expansion-panel-header>

        <!-- ITEM SEARCH, CATEGORY, AND RARITY FILTERS -->
        <div class="item-contents">
            <div id="item-type-fields" class="field-wrapper">
                <mat-form-field id="search-field">
                    <mat-label>Search Items</mat-label>
                    <input matInput type="text" autocomplete="off" [matAutocomplete]="searchableItems" formControlName="itemSearch">
                    <button mat-button *ngIf="this.itemForm.value.itemSearch != ''" matSuffix mat-icon-button aria-label="Clear" (click)="this.itemForm.patchValue({'itemSearch': ''})">
                        <mat-icon class="icon-light">clear</mat-icon>
                    </button>

                    <mat-autocomplete #searchableItems="matAutocomplete" [class]="'autocomplete-panel'">
                        <mat-optgroup *ngFor="let search of getFilteredItems() | async" [label]="search.category">
                            <mat-option *ngFor="let item of search.items | slice:0:25;" [value]="item">
                                {{item}}
                            </mat-option>
                        </mat-optgroup>
                    </mat-autocomplete>
                </mat-form-field>
                <mat-form-field id="type-field">
                    <mat-label>Item Type</mat-label>
                    <input #itemTypesInput matInput type="text"  autocomplete="off" 
                            [matAutocomplete]="searchableItemTypes" 
                            [placeholder]="itemForm.value.itemCategory"
                            (input)="filteredTypes = filterEnums($event.target.value, this.ITEM_TYPES)"
                            [matAutocompletePosition]="'below'"
                            [value]="itemForm.value.itemCategory"
                            (focus)="$event.target.value = ''; filteredTypes = filterEnums('', this.ITEM_TYPES)"
                            (blur)="$event.target.value = itemForm.value.itemCategory">

                    <mat-icon matSuffix class="icon-dark" [class.rotate]="searchableItemTypes.isOpen">arrow_drop_down</mat-icon>
                    <mat-autocomplete #searchableItemTypes="matAutocomplete" 
                                    [class]="'autocomplete-panel'" 
                                    autoActiveFirstOption="'true'"
                                    (optionSelected)="itemForm.controls.itemCategory.patchValue($event.option.value); itemTypesInput.blur()">
                        <mat-option *ngFor="let type of filteredTypes" [class.mat-selected]="type == itemForm.value.itemCategory" [value]="type">
                            {{type}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
                <mat-form-field id="rarity-field">
                    <mat-label>Item Rarity</mat-label>
                    <input #itemRaritiesInput matInput type="text"  autocomplete="off" 
                            [matAutocomplete]="searchableItemRarities" 
                            [placeholder]="itemForm.value.itemRarity"
                            (input)="filteredRarities = filterEnums($event.target.value, ITEM_RARITIES)"
                            [matAutocompletePosition]="'below'"
                            [value]="itemForm.value.itemRarity"
                            (focus)="$event.target.value = ''; filteredRarities = filterEnums('', ITEM_RARITIES)"
                            (blur)="$event.target.value = itemForm.value.itemRarity">

                    <mat-icon matSuffix class="icon-dark" [class.rotate]="searchableItemRarities.isOpen">arrow_drop_down</mat-icon>
                    <mat-autocomplete #searchableItemRarities="matAutocomplete" 
                                    [class]="'autocomplete-panel'" 
                                    autoActiveFirstOption="'true'"
                                    (optionSelected)="itemForm.controls.itemRarity.patchValue($event.option.value); itemRaritiesInput.blur()">
                        <mat-option *ngFor="let rarity of filteredRarities" [class.mat-selected]="rarity == itemForm.value.itemRarity" [value]="rarity">
                            {{rarity}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
            </div>

            <!-- WEAPON FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Weapon Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper">
                        <app-minmaxinput class="min-max-field" inputName="Damage" [group]="this.itemForm.get('weaponFilters.damage')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Attacks Per Second" [group]="this.itemForm.get('weaponFilters.APS')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Critical Strike Chance" [group]="this.itemForm.get('weaponFilters.criticalStrikeChance')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Total DPS" [group]="this.itemForm.get('weaponFilters.totalDPS')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Physcial DPS" [group]="this.itemForm.get('weaponFilters.pDPS')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Elemental DPS" [group]="this.itemForm.get('weaponFilters.eDPS')"></app-minmaxinput>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- ARMOUR FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Armour Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper">
                        <app-minmaxinput class="min-max-field" inputName="Armour" [group]="this.itemForm.get('armourFilters.armour')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Energy Shield" [group]="this.itemForm.get('armourFilters.energyShield')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Evasion" [group]="this.itemForm.get('armourFilters.evasion')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Block Chance" [group]="this.itemForm.get('armourFilters.blockChance')"></app-minmaxinput>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- SOCKET FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Socket Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper">
                        <app-minmaxinput class="min-max-field" inputName="Sockets" [group]="this.itemForm.get('socketFilters.sockets')" [minmaxExtras]="socketSocketsExtras"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Links" [group]="this.itemForm.get('socketFilters.links')" [minmaxExtras]="socketLinksExtras"></app-minmaxinput>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- REQUIREMENTS FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Requirements
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper">
                        <app-minmaxinput class="min-max-field" inputName="Level" [group]="this.itemForm.get('requirementFilters.level')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Strength" [group]="this.itemForm.get('requirementFilters.strength')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Intelligence" [group]="this.itemForm.get('requirementFilters.intelligence')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Dexterity" [group]="this.itemForm.get('requirementFilters.dexterity')"></app-minmaxinput>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- MAP FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Map Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper" formGroupName="mapFilters">
                        <app-filtergroupselect class="group-filter-input" inputName='Region' [control]="itemForm.get('mapFilters.region')" [selectEnum]="MAP_REGION"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Series' [control]="itemForm.get('mapFilters.series')" [selectEnum]="MAP_SERIES"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Shaped' [control]="itemForm.get('mapFilters.shaped')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Elder' [control]="itemForm.get('mapFilters.elder')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Blighted' [control]="itemForm.get('mapFilters.blighted')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-minmaxinput class="min-max-field" inputName="Tier" [group]="this.itemForm.get('mapFilters.tier')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Packsize" [group]="this.itemForm.get('mapFilters.packsize')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="IIQ" [group]="this.itemForm.get('mapFilters.iiq')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="IIR" [group]="this.itemForm.get('mapFilters.iir')"></app-minmaxinput>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- INFLUENCE & SPECIAL BASES FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Influences & Special Bases
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper" formGroupName="mapFilters">
                        <app-filtergroupselect class="group-filter-input" inputName='Shaper Influence' [control]="itemForm.get('influenceFilters.shaper')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Elder Influence' [control]="itemForm.get('influenceFilters.elder')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Crusader Influence' [control]="itemForm.get('influenceFilters.crusader')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Redeemer Influence' [control]="itemForm.get('influenceFilters.redeemer')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Hunter Influence' [control]="itemForm.get('influenceFilters.hunter')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Warlord Influence' [control]="itemForm.get('influenceFilters.warlord')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Fractured' [control]="itemForm.get('influenceFilters.fractured')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                        <app-filtergroupselect class="group-filter-input" inputName='Synthesised' [control]="itemForm.get('influenceFilters.synthesised')" [selectEnum]="TRUE_FALSE"></app-filtergroupselect>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- GEM FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Gem Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper">
                        <app-minmaxinput class="min-max-field" inputName="Level" [group]="this.itemForm.get('gemFilters.level')"></app-minmaxinput>
                        <app-minmaxinput class="min-max-field" inputName="Experience (%)" [group]="this.itemForm.get('gemFilters.experience')"></app-minmaxinput>
                        <app-filtergroupselect class="group-filter-input" inputName='Quality Type' [control]="itemForm.get('gemFilters.qualityType')" [selectEnum]="GEM_QUALITY_TYPES"></app-filtergroupselect>
                    </div>
                </div>
            </mat-expansion-panel>

        </div>
    </mat-expansion-panel>
</form>

