<form [formGroup]="itemForm">
    <mat-expansion-panel [expanded]="'true'">

        <mat-expansion-panel-header>
            <mat-panel-title>
                <div class="item-delete" (click)="$event.stopImmediatePropagation(); remove()">
                    <mat-icon class="icon-light">delete</mat-icon>
                </div>
            </mat-panel-title>
            <div *ngIf="!this.getEditName()" class="item-name" 
                (click)="$event.stopImmediatePropagation(); this.setEditName(true)" 
                role="button" aria-label="Edit item name">
                <p>{{itemForm.value.itemName}}</p>
                <mat-icon class="icon-light">edit</mat-icon>
            </div>
            <mat-form-field *ngIf="this.getEditName()" [floatLabel]="'never'" (click)="$event.stopImmediatePropagation();" >
                <input #itemNameInput matInput 
                    (keydown.Space)="$event.stopImmediatePropagation()" 
                    (keydown.enter)="$event.stopImmediatePropagation(); $event.target.blur()"
                    (blur)="this.setEditName(false)" type="text" autocomplete="off" placeholder="Item Name"  formControlName="itemName">
            </mat-form-field>
        </mat-expansion-panel-header>

        <!-- ITEM SEARCH, CATEGORY, AND RARITY FILTERS -->
        <div class="item-contents">
            <div id="item-type-fields" class="field-wrapper">
                <mat-form-field id="search-field">
                    <mat-label>Search Items</mat-label>
                    <input matInput type="text" autocomplete="off" [matAutocomplete]="searchableItems" formControlName="itemSearch">
                    <button mat-button *ngIf="this.itemForm.value.itemSearch != ''" matSuffix mat-icon-button aria-label="Clear" (click)="this.itemForm.patchValue({'itemSearch': ''})">
                        <mat-icon class="icon-light">clear</mat-icon>
                    </button>

                    <mat-autocomplete #searchableItems="matAutocomplete" [class]="'autocomplete-panel'">
                        <mat-optgroup *ngFor="let search of getFilteredItems() | async" [label]="search.category">
                            <mat-option *ngFor="let item of search.items | slice:0:25;" [value]="item">
                                {{item}}
                            </mat-option>
                        </mat-optgroup>
                    </mat-autocomplete>
                </mat-form-field>
                <mat-form-field id="type-field">
                    <mat-label>Item Type</mat-label>
                    <input #itemTypesInput matInput type="text"  autocomplete="off" 
                            [matAutocomplete]="searchableItemTypes" 
                            [placeholder]="itemForm.value.itemCategory"
                            (input)="filteredTypes = filterEnums($event.target.value, this.ITEM_TYPES)"
                            [matAutocompletePosition]="'below'"
                            [value]="itemForm.value.itemCategory"
                            (focus)="$event.target.value = ''; filteredTypes = filterEnums('', this.ITEM_TYPES)"
                            (blur)="$event.target.value = itemForm.value.itemCategory">

                    <mat-icon matSuffix class="icon-dark" [class.rotate]="searchableItemTypes.isOpen">arrow_drop_down</mat-icon>
                    <mat-autocomplete #searchableItemTypes="matAutocomplete" 
                                    [class]="'autocomplete-panel'" 
                                    autoActiveFirstOption="'true'"
                                    (optionSelected)="itemForm.controls.itemCategory.patchValue($event.option.value); itemTypesInput.blur()">
                        <mat-option *ngFor="let type of filteredTypes" [class.mat-selected]="type == itemForm.value.itemCategory" [value]="type">
                            {{type}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
                <mat-form-field id="rarity-field">
                    <mat-label>Item Rarity</mat-label>
                    <input #itemRaritiesInput matInput type="text"  autocomplete="off" 
                            [matAutocomplete]="searchableItemRarities" 
                            [placeholder]="itemForm.value.itemRarity"
                            (input)="filteredRarities = filterEnums($event.target.value, ITEM_RARITIES)"
                            [matAutocompletePosition]="'below'"
                            [value]="itemForm.value.itemRarity"
                            (focus)="$event.target.value = ''; filteredRarities = filterEnums('', ITEM_RARITIES)"
                            (blur)="$event.target.value = itemForm.value.itemRarity">

                    <mat-icon matSuffix class="icon-dark" [class.rotate]="searchableItemRarities.isOpen">arrow_drop_down</mat-icon>
                    <mat-autocomplete #searchableItemRarities="matAutocomplete" 
                                    [class]="'autocomplete-panel'" 
                                    autoActiveFirstOption="'true'"
                                    (optionSelected)="itemForm.controls.itemRarity.patchValue($event.option.value); itemRaritiesInput.blur()">
                        <mat-option *ngFor="let rarity of filteredRarities" [class.mat-selected]="rarity == itemForm.value.itemRarity" [value]="rarity">
                            {{rarity}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
            </div>

            <!-- WEAPON FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Weapon Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper" formGroupName="weaponFilters">
                        <div class="min-max-field" formGroupName="damage">
                            <p class="min-max-field-label">Damage</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="APS">
                            <p class="min-max-field-label">Attacks Per Second</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="criticalStrikeChance">
                            <p class="min-max-field-label">Critical Strike Chance</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="totalDPS">
                            <p class="min-max-field-label">Total DPS</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="pDPS">
                            <p class="min-max-field-label">Physcial DPS</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="eDPS">
                            <p class="min-max-field-label">Elemental DPS</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
            </mat-expansion-panel>

             <!-- ARMOUR FILTERS -->
             <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Armour Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper" formGroupName="armourFilters">
                        <div class="min-max-field" formGroupName="armour">
                            <p class="min-max-field-label">Armour</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="energyShield">
                            <p class="min-max-field-label">Energy Shield</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="evasion">
                            <p class="min-max-field-label">Evasion</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                        <div class="min-max-field" formGroupName="blockChance">
                            <p class="min-max-field-label">Block Chance</p>
                            <mat-form-field>
                                <mat-label>Min</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="min">
                            </mat-form-field>
                            <mat-form-field>
                                <mat-label>Max</mat-label>
                                <input digitsonly [float]="'true'" matInput type="text" autocomplete="off" formControlName="max">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
            </mat-expansion-panel>

            <!-- ARMOUR FILTERS -->
            <mat-expansion-panel class="sub-item-expansion">
                <mat-expansion-panel-header>
                        Socket Filters
                </mat-expansion-panel-header>
                <div class="item-contents">
                    <div appEqualflex id="item-type-fields" class="field-wrapper" formGroupName="socketFilters">
                        <div class="min-max-field" formGroupName="sockets">
                            <p class="min-max-field-label">Sockets</p>
                            <div class="sub-min-max-fields">
                                <mat-form-field class="socket-input-r">
                                    <mat-label>Red</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="red">
                                </mat-form-field>
                                <mat-form-field class="socket-input-g">
                                    <mat-label>Green</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="green">
                                </mat-form-field>
                                <mat-form-field class="socket-input-b">
                                    <mat-label>Blue</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="blue">
                                </mat-form-field>
                                <mat-form-field class="socket-input-w">
                                    <mat-label>White</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="white">
                                </mat-form-field>
                            </div>
                            <div class="min-max-fields">
                                <mat-form-field>
                                    <mat-label>Min</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="min">
                                </mat-form-field>
                                <mat-form-field>
                                    <mat-label>Max</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="max">
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="min-max-field" formGroupName="links">
                            <p class="min-max-field-label">Links</p>
                            <div class="sub-min-max-fields">
                                <mat-form-field class="socket-input-r">
                                    <mat-label>Red</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="red">
                                </mat-form-field>
                                <mat-form-field class="socket-input-g">
                                    <mat-label>Green</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="green">
                                </mat-form-field>
                                <mat-form-field class="socket-input-b">
                                    <mat-label>Blue</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="blue">
                                </mat-form-field>
                                <mat-form-field class="socket-input-w">
                                    <mat-label>White</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="white">
                                </mat-form-field>
                            </div>
                            <div class="min-max-fields">
                                <mat-form-field>
                                    <mat-label>Min</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="min">
                                </mat-form-field>
                                <mat-form-field>
                                    <mat-label>Max</mat-label>
                                    <input digitsonly matInput type="text" autocomplete="off" formControlName="max">
                                </mat-form-field>
                            </div>
                        </div>
                    </div>
                </div>
            </mat-expansion-panel>
        </div>
    </mat-expansion-panel>
</form>

